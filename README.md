# Nutritive bot

Телеграм-бот для рассчета нормы потребления нутриентов

## Добавление новых нутриентов и вопросов

### Добавление нового вопроса для вычисления нутриента

1. В файле `config.py` добавить новый атрибут для класса `Question` с названием строки, которой будет соотвествовать данный вопрос (должен отличаться от всех предыдущих и не совпадать со строкой "chat_id")
2. Подключиться к базе данных и добавить новый столбец с названием этого вопроса, данного в предыдущем пункте. Сделать это можно следующим запросом:
```
ALTER TABLE Answers ADD COLUMN question_name TYPE_NAME;
```
3. В файле `db_operations.py` в методе `__create_table_if_not_exitsts` класса `UsersData` добавить для таблицы `Answers` новый столбец на случай если будем переезжать на новую базу данных.
4. Добавить наш вопрос в конфиг `questions.yml` со следующими параметрами:
   - `question_text` - формулировка вопроса
   - `answers` - опционально, если хотите чтобы ваш вопрос представлял несколько вариантов ответа, которые отображаются в виде кнопок в телеграме.
   - вы можете добавлять новые поля, которые будете в дальнейшем использовать для сообщений с неправильном  форматом ответа.
5. В файле `question_checker.py` добавить функцию которая по ответу пользователя выдает результат в виде объекта класса `CheckerResponse`, который хранит в себе следующие атрибуты:
   - `message` - ответ пользователю. Оставить `None` чтобы не было ответного сообщения (например в случае корректного ответа пользователя)
   - `result` - результат ответа на вопрос, который пойдет в базу данных.
   - `status` - **True** если ответ был корректным, **False**. В первом случае результат будет добавлен в базу данных и произойдет переход на следующий вопрос. Во втором случае будет сообщение об ошибке и повторное ожидание ответа на вопрос.

6. Добавить данную функцию в словарь `question_checker` с названием вопроса в качестве ключа.

### Добавление нового нутриента

1. В файле `config.py` добавить новый атрибут для класса `Nutrient` с уникальным идентификатором данного нутриента.
2. Добавить нутриент в конфиг `nutrients.yml` со следующими параметрами:
   - `name` - название нутриента, которое будет отображаться в боте.
   - `produced` - текст, с описанием продуктов в которых содержится данный нутриент.
   - `properties` - текст с свойствами данного нутриента.
   - `symbol` (DEPRICATED) - символ данного нутриента, по умолчанию делать таким же как и идентификатор
   - `questions` - список вопросов которые будут заданы для вычисления нормы (список существующих вопросов смотреть в `questions.yml`). Если вопросов нет, оставить поле пустым или не добавлять его.
   - `results` - словарь с возможными результатами вычисления нормы для нутриента. В случае когда нет вопросов и можно дать однозначный ответ по норме нутриента добавить один элемент с ключом `default`.

3. Если норма потребление задается не однозначно (т.е. требуется задавать вопросы), то нужно добавить в файл `nutrients_logic.py` функцию, определяющую норму. На вход она принимает ответы на заданные вопросы в виде словаря, ключи которого являются названиями вопросов. Затем эту функцию нужно добавить в cловарь `__dipatcher` класса `NutrientsCalculator`.

## Выкатка нового релиза

1. Вкоммитить изменения в `master`
2. Перейти на сервере в папку `~/prod/nutritive_bot`
3. Получить изменения с гитхаба командой `git pull`
4. При необходимости внести изменения в бд `~/prod/nutritive_bot/prod_users.db`
5. Обновить сервис `systemctl restart nutritive.service`
6. Проверить что все ок `systemctl status nutritive.service`
7. Если не ок, смотреть логи `sudo journalctl -u nutritive.service`